<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Receipt Breakdown - OnlyBills</title>
    <meta name="description" content="View the detailed breakdown of this shared receipt">
    <meta name="theme-color" content="#000000">

    <meta property="og:title" content="Receipt Breakdown - OnlyBills">
    <meta property="og:description" content="View how this bill was split">
    <meta property="og:type" content="website">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #000;
            --card: rgba(255,255,255,0.05);
            --card-hover: rgba(255,255,255,0.08);
            --text: #fff;
            --text-dim: rgba(255,255,255,0.6);
            --text-muted: rgba(255,255,255,0.35);
            --green: #32D74B;
            --border: rgba(255,255,255,0.08);
            --safe-b: env(safe-area-inset-bottom, 16px);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
        }

        .wrap {
            max-width: 440px;
            margin: 0 auto;
            padding: 0 16px 120px;
        }

        /* Header */
        .hero {
            position: relative;
            margin: 0 -16px 16px;
            height: 180px;
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a1a, #0d0d0d);
        }

        .hero-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .hero-img.loaded { opacity: 1; }

        .hero-grad {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, var(--bg) 0%, transparent 60%);
        }

        .hero-content {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
        }

        .place-name {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.4px;
            margin-bottom: 4px;
        }

        .place-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-dim);
            flex-wrap: wrap;
        }

        .star { color: #FFD60A; }
        .dot { opacity: 0.4; }

        /* Total */
        .total-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--card);
            border-radius: 14px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .total-left {
            display: flex;
            flex-direction: column;
        }

        .total-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .total-people {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .total-amount {
            font-size: 26px;
            font-weight: 700;
            color: var(--green);
            letter-spacing: -0.5px;
        }

        /* Section */
        .section { margin-bottom: 20px; }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 10px;
            padding-left: 2px;
        }

        /* Person */
        .person {
            background: var(--card);
            border-radius: 14px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .person-head {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .person-head:active { background: var(--card-hover); }

        .avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 13px;
            color: #fff;
            flex-shrink: 0;
            overflow: hidden;
        }

        .avatar.emoji {
            font-size: 20px;
            background: transparent !important;
        }

        .person-info {
            flex: 1;
            margin-left: 10px;
            min-width: 0;
        }

        .person-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .person-sub {
            font-size: 11px;
            color: var(--text-muted);
        }

        .person-amt {
            font-size: 15px;
            font-weight: 700;
            color: var(--green);
            margin-right: 6px;
        }

        .chev {
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .person.open .chev { transform: rotate(180deg); }

        .person-body {
            display: none;
            padding: 0 14px 12px;
            border-top: 1px solid var(--border);
        }

        .person.open .person-body { display: block; }

        .item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 13px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        .item:last-child { border-bottom: none; }
        .item-name { color: var(--text-dim); flex: 1; padding-right: 10px; }
        .item-price { font-weight: 500; }

        .fees {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        .fee {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
            padding: 3px 0;
        }

        /* Receipt */
        .receipt-box {
            background: var(--card);
            border-radius: 14px;
            padding: 10px;
        }

        .receipt-img {
            width: 100%;
            border-radius: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .receipt-img.loaded { opacity: 1; }

        /* Footer */
        .footer {
            text-align: center;
            padding: 24px 0 8px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .footer a { color: var(--green); text-decoration: none; }

        /* Banner */
        .banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-b));
            background: linear-gradient(to top, rgba(0,0,0,0.97), rgba(0,0,0,0.9) 80%, transparent);
        }

        .dl-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 200px;
            margin: 0 auto;
            padding: 8px 16px;
            background: #fff;
            border-radius: 8px;
            text-decoration: none;
            transition: transform 0.15s;
        }

        .dl-btn:active { transform: scale(0.97); }

        .dl-btn svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .dl-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .dl-small {
            font-size: 8px;
            color: #666;
            font-weight: 500;
        }

        .dl-big {
            font-size: 14px;
            color: #000;
            font-weight: 600;
            letter-spacing: -0.2px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 999;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.show { display: flex; }

        .modal-close {
            position: absolute;
            top: max(16px, env(safe-area-inset-top));
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }

        .modal-img {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 8px;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70vh;
            gap: 12px;
        }

        .spin {
            width: 28px;
            height: 28px;
            border: 2px solid var(--border);
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { font-size: 13px; color: var(--text-muted); }

        /* Error */
        .error {
            text-align: center;
            padding: 60px 20px;
        }

        .error-icon { font-size: 40px; margin-bottom: 12px; }
        .error-title { font-size: 18px; font-weight: 600; margin-bottom: 6px; }
        .error-msg { font-size: 13px; color: var(--text-dim); }

        /* Skeleton */
        .skel {
            background: linear-gradient(90deg, var(--card) 25%, rgba(255,255,255,0.08) 50%, var(--card) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }

        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>
    <div class="wrap" id="app">
        <div class="loading">
            <div class="spin"></div>
            <p class="loading-text">Loading...</p>
        </div>
    </div>

    <div class="modal" id="modal" onclick="closeModal()">
        <button class="modal-close">&times;</button>
        <img class="modal-img" id="modalImg">
    </div>

    <div class="banner">
        <a href="https://apps.apple.com/app/onlybills" class="dl-btn">
            <svg viewBox="0 0 24 24" fill="none">
                <path d="M17.05 12.76c-.02-2.33 1.83-3.46 1.91-3.51-.94-1.54-2.6-1.76-3.2-1.78-1.39-.14-2.74.87-3.45.87-.72 0-1.82-.85-3-.83-1.52.03-2.94.94-3.72 2.31-1.61 2.8-.41 6.94 1.13 9.21.77 1.11 1.68 2.35 2.86 2.31 1.15-.04 1.58-.74 2.96-.74 1.37 0 1.77.74 2.97.71 1.24-.02 2.02-1.11 2.76-2.23.9-1.28 1.26-2.55 1.27-2.61-.03-.01-2.32-.89-2.34-3.52z" fill="#000"/>
                <path d="M14.8 5.96c.63-.77 1.06-1.82.94-2.88-.91.04-2.04.64-2.7 1.4-.58.67-1.1 1.75-.97 2.78 1.02.08 2.08-.51 2.73-1.3z" fill="#000"/>
            </svg>
            <div class="dl-text">
                <span class="dl-small">Download on the</span>
                <span class="dl-big">App Store</span>
            </div>
        </a>
    </div>

    <script>
        firebase.initializeApp({
            apiKey: "AIzaSyByDh_nxkV1kWGdIHFldDAoIU7iGqU3FQc",
            authDomain: "onlybills-b8dac.firebaseapp.com",
            projectId: "onlybills-b8dac",
            storageBucket: "onlybills-b8dac.firebasestorage.app",
            messagingSenderId: "572680746912",
            appId: "1:572680746912:web:9c3890b712bdc19a9a16c5"
        });

        const db = firebase.firestore();
        const id = new URLSearchParams(location.search).get('id');

        const fmt = (n, c) => {
            const s = { GBP:'Â£', USD:'$', EUR:'â‚¬', JPY:'Â¥', CAD:'C$', AUD:'A$', SGD:'S$', MYR:'RM', THB:'à¸¿', INR:'â‚¹', KRW:'â‚©', CNY:'Â¥', HKD:'HK$' };
            return (s[c] || c + ' ') + n.toFixed(2);
        };

        const fmtDate = t => {
            const d = t.toDate ? t.toDate() : new Date(t);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        };

        const fmtCount = n => n >= 1000 ? (n/1000).toFixed(1) + 'K' : n;

        // Check if string starts with emoji
        const startsWithEmoji = str => {
            const emojiRegex = /^(?:\p{Emoji_Presentation}|\p{Emoji}\uFE0F)/u;
            return emojiRegex.test(str.trim());
        };

        const getDisplay = name => {
            const n = name.trim();
            if (startsWithEmoji(n)) {
                // Extract first emoji cluster
                const match = n.match(/^(\p{Emoji_Presentation}|\p{Emoji}\uFE0F|\p{Emoji})/u);
                return { emoji: true, char: match ? match[0] : n.charAt(0) };
            }
            const p = n.split(' ');
            const initials = p.length >= 2 ? (p[0][0] + p[1][0]).toUpperCase() : n.charAt(0).toUpperCase();
            return { emoji: false, char: initials };
        };

        const toggle = el => el.closest('.person').classList.toggle('open');

        const openModal = src => {
            document.getElementById('modalImg').src = src;
            document.getElementById('modal').classList.add('show');
            document.body.style.overflow = 'hidden';
        };

        const closeModal = () => {
            document.getElementById('modal').classList.remove('show');
            document.body.style.overflow = '';
        };

        document.addEventListener('keydown', e => e.key === 'Escape' && closeModal());

        const lazyImg = (src, cls) => {
            const img = document.createElement('img');
            img.className = cls;
            img.onload = () => img.classList.add('loaded');
            img.src = src;
            return img.outerHTML.replace('>', ` src="${src}">`);
        };

        const render = d => {
            let h = '';

            // Hero
            h += `<div class="hero">`;
            if (d.restaurantPhotoUrl) {
                h += `<img class="hero-img" onload="this.classList.add('loaded')" src="${d.restaurantPhotoUrl}" alt="">`;
            }
            h += `<div class="hero-grad"></div>`;
            h += `<div class="hero-content">`;
            h += `<h1 class="place-name">${d.storeName}</h1>`;
            h += `<div class="place-meta">`;
            if (d.rating) {
                h += `<span><span class="star">â˜…</span> ${d.rating.toFixed(1)}`;
                if (d.ratingCount) h += ` (${fmtCount(d.ratingCount)})`;
                h += `</span>`;
            }
            if (d.rating && d.placeType) h += `<span class="dot">Â·</span>`;
            if (d.placeType) h += `<span>${d.placeType}</span>`;
            if ((d.rating || d.placeType) && d.date) h += `<span class="dot">Â·</span>`;
            h += `<span>${fmtDate(d.date)}</span>`;
            h += `</div></div></div>`;

            // Total row
            h += `<div class="total-row">`;
            h += `<div class="total-left">`;
            h += `<span class="total-label">Total</span>`;
            h += `<span class="total-people">${d.people.length} ${d.people.length === 1 ? 'person' : 'people'}</span>`;
            h += `</div>`;
            h += `<span class="total-amount">${fmt(d.totalBill, d.currency)}</span>`;
            h += `</div>`;

            // People
            h += `<div class="section">`;
            h += `<div class="section-title">Breakdown</div>`;

            d.people.forEach(p => {
                const disp = getDisplay(p.name);
                const items = p.items?.length || 0;

                h += `<div class="person">`;
                h += `<div class="person-head" onclick="toggle(this)">`;

                if (disp.emoji) {
                    h += `<div class="avatar emoji">${disp.char}</div>`;
                } else {
                    h += `<div class="avatar" style="background:${p.color}">${disp.char}</div>`;
                }

                h += `<div class="person-info">`;
                h += `<div class="person-name">${p.name}</div>`;
                h += `<div class="person-sub">${items} item${items !== 1 ? 's' : ''}</div>`;
                h += `</div>`;
                h += `<span class="person-amt">${fmt(p.total, d.currency)}</span>`;
                h += `<svg class="chev" width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
                h += `</div>`;

                h += `<div class="person-body">`;
                if (p.items?.length) {
                    p.items.forEach(i => {
                        const q = i.quantity && i.quantity !== 1 ? ` Ã—${i.quantity}` : '';
                        h += `<div class="item"><span class="item-name">${i.name}${q}</span><span class="item-price">${fmt(i.price, d.currency)}</span></div>`;
                    });
                }

                if ((p.tax > 0) || (p.serviceCharge > 0) || (p.tip > 0)) {
                    h += `<div class="fees">`;
                    if (p.tax > 0) h += `<div class="fee"><span>Tax</span><span>${fmt(p.tax, d.currency)}</span></div>`;
                    if (p.serviceCharge > 0) h += `<div class="fee"><span>Service</span><span>${fmt(p.serviceCharge, d.currency)}</span></div>`;
                    if (p.tip > 0) h += `<div class="fee"><span>Tip</span><span>${fmt(p.tip, d.currency)}</span></div>`;
                    h += `</div>`;
                }

                h += `</div></div>`;
            });

            h += `</div>`;

            // Receipt
            if (d.receiptImageUrl) {
                h += `<div class="section">`;
                h += `<div class="section-title">Receipt</div>`;
                h += `<div class="receipt-box">`;
                h += `<img class="receipt-img" onload="this.classList.add('loaded')" src="${d.receiptImageUrl}" onclick="openModal('${d.receiptImageUrl}')">`;
                h += `</div></div>`;
            }

            h += `<div class="footer">Split with <a href="https://apps.apple.com/app/onlybills">OnlyBills</a></div>`;

            document.getElementById('app').innerHTML = h;
        };

        const showErr = m => {
            document.getElementById('app').innerHTML = `
                <div class="error">
                    <div class="error-icon">ðŸ˜•</div>
                    <div class="error-title">Not Found</div>
                    <div class="error-msg">${m}</div>
                </div>`;
        };

        (async () => {
            if (!id) return showErr('No receipt ID');
            try {
                const doc = await db.collection('sharedReceipts').doc(id).get();
                if (!doc.exists) return showErr('Receipt not found');
                render(doc.data());
                document.title = doc.data().storeName + ' - OnlyBills';
            } catch (e) {
                console.error(e);
                showErr('Error loading');
            }
        })();
    </script>
</body>
</html>
