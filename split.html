<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Receipt Breakdown - OnlyBills</title>
    <meta name="description" content="View the detailed breakdown of this shared receipt">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="Receipt Breakdown - OnlyBills">
    <meta property="og:description" content="View how this bill was split">
    <meta property="og:type" content="website">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #000000;
            --bg-card: rgba(255, 255, 255, 0.06);
            --bg-card-hover: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            --accent: #34C759;
            --accent-blue: #007AFF;
            --border: rgba(255, 255, 255, 0.1);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -webkit-text-size-adjust: 100%;
            min-height: 100vh;
            min-height: 100dvh;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 0 16px;
            padding-bottom: calc(140px + var(--safe-bottom));
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            gap: 16px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-tertiary);
            font-size: 14px;
        }

        /* Error */
        .error {
            text-align: center;
            padding: 80px 24px;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.8;
        }

        .error-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .error-message {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 32px;
        }

        /* Header */
        .header {
            position: relative;
            margin: 0 -16px;
            overflow: hidden;
        }

        .header-image {
            width: 100%;
            height: 220px;
            object-fit: cover;
        }

        .header-placeholder {
            width: 100%;
            height: 160px;
            background: linear-gradient(145deg, #1a1a1a 0%, #0a0a0a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-placeholder-icon {
            font-size: 40px;
            opacity: 0.2;
        }

        .header-gradient {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 140px;
            background: linear-gradient(to top, var(--bg-primary) 0%, transparent 100%);
        }

        .header-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
        }

        .store-name {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.3px;
            margin-bottom: 8px;
        }

        .store-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .rating {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .star {
            color: #FFD60A;
        }

        .meta-separator {
            opacity: 0.3;
        }

        /* Total Section */
        .total-section {
            padding: 24px 20px;
            margin: 16px 0;
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.15) 0%, rgba(52, 199, 89, 0.05) 100%);
            border-radius: 20px;
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .total-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .total-amount {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .total-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* Section */
        .section {
            margin: 24px 0;
        }

        .section-header {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 4px;
        }

        /* Person Card */
        .person-card {
            background: var(--bg-card);
            border-radius: 16px;
            margin-bottom: 10px;
            overflow: hidden;
            transition: background 0.2s ease;
        }

        .person-card:active {
            background: var(--bg-card-hover);
        }

        .person-header {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .person-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }

        .person-info {
            flex: 1;
            margin-left: 12px;
        }

        .person-name {
            font-size: 15px;
            font-weight: 600;
        }

        .person-items-count {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 1px;
        }

        .person-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            margin-right: 8px;
        }

        .chevron {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            transition: transform 0.25s ease;
        }

        .person-card.expanded .chevron {
            transform: rotate(180deg);
        }

        .person-details {
            display: none;
            padding: 0 16px 14px;
            border-top: 1px solid var(--border);
        }

        .person-card.expanded .person-details {
            display: block;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            font-size: 14px;
        }

        .item-row:not(:last-child) {
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .item-name {
            color: var(--text-secondary);
            flex: 1;
            padding-right: 12px;
        }

        .item-price {
            font-weight: 500;
        }

        .fees-section {
            margin-top: 8px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .fee-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
            color: var(--text-tertiary);
        }

        /* Receipt Image */
        .receipt-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 12px;
            margin-top: 8px;
        }

        .receipt-image {
            width: 100%;
            border-radius: 12px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .receipt-image:active {
            opacity: 0.8;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 32px 0 16px;
        }

        .footer-text {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .footer-text a {
            color: var(--accent);
            text-decoration: none;
        }

        /* Download Banner */
        .download-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            padding-bottom: calc(16px + var(--safe-bottom));
            background: linear-gradient(to top, rgba(0,0,0,0.98) 0%, rgba(0,0,0,0.95) 70%, transparent 100%);
            z-index: 100;
        }

        .download-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            max-width: 380px;
            margin: 0 auto;
            padding: 12px 20px;
            background: #ffffff;
            border-radius: 12px;
            text-decoration: none;
            transition: transform 0.2s, opacity 0.2s;
        }

        .download-button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .app-store-badge {
            width: 24px;
            height: 24px;
        }

        .download-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .download-subtitle {
            font-size: 9px;
            font-weight: 500;
            color: #666;
            letter-spacing: 0.2px;
            line-height: 1;
        }

        .download-title {
            font-size: 15px;
            font-weight: 600;
            color: #000;
            letter-spacing: -0.2px;
            line-height: 1.2;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            padding: 20px;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-close {
            position: absolute;
            top: max(20px, env(safe-area-inset-top));
            right: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-image {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 8px;
        }

        /* Address */
        .address {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        @media (min-width: 500px) {
            .container {
                padding: 0 24px;
                padding-bottom: calc(160px + var(--safe-bottom));
            }

            .header {
                margin: 0 -24px;
            }

            .header-image {
                height: 260px;
            }

            .store-name {
                font-size: 28px;
            }

            .total-amount {
                font-size: 42px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="content">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p class="loading-text">Loading breakdown...</p>
        </div>
    </div>

    <div class="modal" id="imageModal" onclick="closeModal()">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <img class="modal-image" id="modalImage" src="" alt="Receipt">
    </div>

    <div class="download-banner">
        <a href="https://apps.apple.com/app/onlybills" class="download-button">
            <svg class="app-store-badge" viewBox="0 0 24 24" fill="none">
                <path d="M17.0349 12.7587C17.0166 10.4259 18.8651 9.29638 18.9528 9.24094C17.8865 7.70181 16.2217 7.48562 15.6255 7.46686C14.2331 7.32159 12.8857 8.30993 12.1788 8.30993C11.4569 8.30993 10.3615 7.48187 9.18285 7.50688C7.66241 7.53127 6.24666 8.41618 5.46598 9.78855C3.85341 12.5916 5.05146 16.7278 6.59614 18.9953C7.36933 20.1048 8.27721 21.3455 9.45525 21.3018C10.6046 21.2537 11.0295 20.5531 12.4119 20.5531C13.7793 20.5531 14.1754 21.3018 15.377 21.2724C16.6142 21.2537 17.3992 20.1579 18.1437 19.038C19.0428 17.7536 19.3952 16.4917 19.4096 16.4255C19.3796 16.4168 17.0562 15.5281 17.0349 12.7587Z" fill="black"/>
                <path d="M14.8054 5.96162C15.4366 5.19033 15.8683 4.14327 15.7493 3.08008C14.8386 3.12071 13.7038 3.69759 13.0439 4.45263C12.4577 5.12268 11.9335 6.20709 12.0675 7.22951C13.0864 7.30682 14.1449 6.72057 14.8054 5.96162Z" fill="black"/>
            </svg>
            <div class="download-content">
                <span class="download-subtitle">Download on the</span>
                <span class="download-title">App Store</span>
            </div>
        </a>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyByDh_nxkV1kWGdIHFldDAoIU7iGqU3FQc",
            authDomain: "onlybills-b8dac.firebaseapp.com",
            projectId: "onlybills-b8dac",
            storageBucket: "onlybills-b8dac.firebasestorage.app",
            messagingSenderId: "572680746912",
            appId: "1:572680746912:web:9c3890b712bdc19a9a16c5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const receiptId = urlParams.get('id');

        function formatPrice(amount, currency) {
            const symbols = {
                'GBP': '¬£', 'USD': '$', 'EUR': '‚Ç¨', 'JPY': '¬•',
                'CAD': 'C$', 'AUD': 'A$', 'CHF': 'CHF', 'CNY': '¬•',
                'SGD': 'S$', 'HKD': 'HK$', 'MYR': 'RM', 'THB': '‡∏ø',
                'INR': '‚Çπ', 'KRW': '‚Ç©'
            };
            return (symbols[currency] || currency + ' ') + amount.toFixed(2);
        }

        function formatDate(timestamp) {
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function formatCount(count) {
            return count >= 1000 ? (count / 1000).toFixed(1) + 'K' : count.toString();
        }

        function getInitials(name) {
            const parts = name.trim().split(' ');
            return parts.length >= 2 ? (parts[0][0] + parts[1][0]).toUpperCase() : name.charAt(0).toUpperCase();
        }

        function togglePerson(el) {
            el.closest('.person-card').classList.toggle('expanded');
        }

        function openModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

        function showError(msg) {
            document.getElementById('content').innerHTML = `
                <div class="error">
                    <div class="error-icon">üòï</div>
                    <h2 class="error-title">Receipt Not Found</h2>
                    <p class="error-message">${msg}</p>
                </div>`;
        }

        function renderReceipt(data) {
            let html = '';

            // Header
            html += `<div class="header">`;
            if (data.restaurantPhotoUrl) {
                html += `<img class="header-image" src="${data.restaurantPhotoUrl}" alt="${data.storeName}">`;
            } else {
                html += `<div class="header-placeholder"><span class="header-placeholder-icon">üçΩÔ∏è</span></div>`;
            }
            html += `<div class="header-gradient"></div>`;
            html += `<div class="header-content">`;
            html += `<h1 class="store-name">${data.storeName}</h1>`;
            html += `<div class="store-meta">`;
            if (data.rating) {
                html += `<span class="rating"><span class="star">‚òÖ</span> ${data.rating.toFixed(1)}`;
                if (data.ratingCount) html += ` (${formatCount(data.ratingCount)})`;
                html += `</span>`;
                if (data.placeType || data.date) html += `<span class="meta-separator">¬∑</span>`;
            }
            if (data.placeType) {
                html += `<span>${data.placeType}</span>`;
                if (data.date) html += `<span class="meta-separator">¬∑</span>`;
            }
            html += `<span>${formatDate(data.date)}</span>`;
            html += `</div>`;
            if (data.address) {
                html += `<div class="address"><span>üìç</span><span>${data.address}</span></div>`;
            }
            html += `</div></div>`;

            // Total
            html += `<div class="total-section">`;
            html += `<div class="total-label">Total Bill</div>`;
            html += `<div class="total-amount">${formatPrice(data.totalBill, data.currency)}</div>`;
            html += `<div class="total-info">Split between ${data.people.length} ${data.people.length === 1 ? 'person' : 'people'}</div>`;
            html += `</div>`;

            // Breakdown
            html += `<div class="section">`;
            html += `<div class="section-header">Breakdown</div>`;

            data.people.forEach((person, i) => {
                const itemCount = person.items?.length || 0;
                html += `<div class="person-card">`;
                html += `<div class="person-header" onclick="togglePerson(this)">`;
                html += `<div class="person-avatar" style="background:${person.color}">${getInitials(person.name)}</div>`;
                html += `<div class="person-info">`;
                html += `<div class="person-name">${person.name}</div>`;
                html += `<div class="person-items-count">${itemCount} item${itemCount !== 1 ? 's' : ''}</div>`;
                html += `</div>`;
                html += `<span class="person-amount">${formatPrice(person.total, data.currency)}</span>`;
                html += `<div class="chevron"><svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>`;
                html += `</div>`;

                html += `<div class="person-details">`;
                if (person.items?.length) {
                    person.items.forEach(item => {
                        const qty = item.quantity && item.quantity !== 1 ? ` √ó ${item.quantity}` : '';
                        html += `<div class="item-row"><span class="item-name">${item.name}${qty}</span><span class="item-price">${formatPrice(item.price, data.currency)}</span></div>`;
                    });
                }

                const hasFees = (person.tax > 0) || (person.serviceCharge > 0) || (person.tip > 0);
                if (hasFees) {
                    html += `<div class="fees-section">`;
                    if (person.tax > 0) html += `<div class="fee-row"><span>Tax</span><span>${formatPrice(person.tax, data.currency)}</span></div>`;
                    if (person.serviceCharge > 0) html += `<div class="fee-row"><span>Service</span><span>${formatPrice(person.serviceCharge, data.currency)}</span></div>`;
                    if (person.tip > 0) html += `<div class="fee-row"><span>Tip</span><span>${formatPrice(person.tip, data.currency)}</span></div>`;
                    html += `</div>`;
                }
                html += `</div></div>`;
            });
            html += `</div>`;

            // Receipt
            if (data.receiptImageUrl) {
                html += `<div class="section">`;
                html += `<div class="section-header">Original Receipt</div>`;
                html += `<div class="receipt-container">`;
                html += `<img class="receipt-image" src="${data.receiptImageUrl}" alt="Receipt" onclick="openModal('${data.receiptImageUrl}')">`;
                html += `</div></div>`;
            }

            // Footer
            html += `<div class="footer"><p class="footer-text">Split with <a href="https://apps.apple.com/app/onlybills">OnlyBills</a></p></div>`;

            document.getElementById('content').innerHTML = html;
        }

        async function loadReceipt() {
            if (!receiptId) { showError('No receipt ID provided.'); return; }
            try {
                const doc = await db.collection('sharedReceipts').doc(receiptId).get();
                if (!doc.exists) { showError('This receipt could not be found.'); return; }
                renderReceipt(doc.data());
                document.title = `${doc.data().storeName} - OnlyBills`;
            } catch (e) {
                console.error(e);
                showError('Error loading receipt. Please try again.');
            }
        }

        loadReceipt();
    </script>
</body>
</html>
